// Evolutionary "Landing Behavior" Simulation


let agents = 200;

var gravity = 0.1;

var epoch = 1;
var stage = 1;
var bestStage = 1;
var bestlander = [];

// An array of landers
let population = [];
let savedPop = [];

// Checkbox to show additional info
let debug;

// Slider to speed up simulation
let speedSlider;
let speedSpan;

let best = null;
var stopAgents = 0;
let goal = 0;
let g_width = 60;
let goal_end = 0;
let goal_mid = 0;
var goal_seq = [200, 450, 300, 170, 500, 150, 550, 350];

function moveGoal(asd) { // TODO goal should not be moved randomly, but in a meticulous way, to foster evolving
  if (asd > 0) {
    goal = Math.floor(random(50, 550));
  } else {
    goal = goal_seq[asd - 1];
  }
  goal_end = goal + g_width;
  goal_mid = Math.floor(goal + (g_width / 2));
}


function setup() {

  moveGoal(1);

  // Add canvas and grab checkbox and slider
  let canvas = createCanvas(640, 360);
  canvas.parent('canvascontainer');
  debug = select('#debug');
  speedSlider = select('#speedSlider');
  speedSpan = select('#speed');

  // Create initial population
  for (let i = 0; i < agents; i++) {
    population[i] = new Lander();
  }
  var ads = new Lander();
  ads.highlight();
  bestlander.push(ads);
}

function draw() {
  background(0);
  fill(color(0, 255, 0));
  rect(0, 300, 640, 60)
  fill(color(255, 0, 0));
  rect(goal, 290, g_width, 10)

  // Should we speed up cycles per frame
  let cycles = speedSlider.value();
  speedSpan.html(cycles);


  // How many times to advance the game
  for (let n = 0; n < cycles; n++) {

    for (let i = population.length - 1; i >= 0; i--) {
      let lander = population[i];
      lander.fly();
      if (!(lander.flying)) {
        if (lander.success == false) {
          stopAgents++;
        }
        lander.setscore();
        savedPop.push(population.splice(i, 1)[0]);
      };
    }


    if ((population.length < 1)) {
      if (agents == stopAgents) {
        // make new population "from clone"
        population = [];
        population = nextGeneration(savedPop);
        moveGoal(1);
        stopAgents = 0;
        savedPop = [];
        epoch++;
        stage = 1;
        document.getElementById("stage").textContent = "stage: " + stage;
        document.getElementById("epoch").textContent = "epoch: " + epoch;
      } else { // some landers are left successed.
        for (let i = savedPop.length - 1; i >= 0; i--) {
          // if success, .newflight()
          if (savedPop[i].success == true) {
            savedPop[i].newflight();
            population.push(savedPop.splice(i, 1)[0]);
          }
        }
        console.log("epoch: " + epoch + "   stage: " + stage + "   point: " + population.length);
        stage++;
        moveGoal(stage);
        if (bestStage < stage) {
          bestStage = stage - 1;
          bestlander = [];
          bestlander.push(population[0]);
          bestlander[0].highlight();
        }
        document.getElementById("stage").textContent = "stage: " + stage;
      }
    }
  }

  for (let i = population.length - 1; i >= 0; i--) {
    let lander = population[i];
    lander.show();
  }
  for (let i = savedPop.length - 1; i >= 0; i--) { //
    let lander = savedPop[i];
    if (lander.success) {
      lander.show();
    }
  }

}

// stage 기록 바뀌면, 그 떄 남아있던 lander를 리스트로 받아서, 다음 기록갱신때까지, 10개씩 없이 복제로 채운다.


/*  best
"{\"input_nodes\":6,\"hidden_nodes\":15,\"output_nodes\":3,\"weights_ih\":{\"rows\":15,\"cols\":6,\"data\":[[0.13405318405679129,3.877451689217892,6.476878617469226,-3.9504020950750425,-1.1718852001143019,-0.9738559329816534],[-1.0606722875456218,-3.89291124940629,3.957486904365736,3.629391667336433,-1.428149126379824,-0.9268963079444832],[-1.3975170718073544,0.08208364645350227,0.8035713551175024,2.2976927188187273,-1.0605433238642015,-5.831656458484742],[-3.9705456532154213,1.2315272746182377,-2.444397879470915,0.30202798949441856,1.1129341415276057,-1.8819545261686061],[2.3385463117379386,0.9186630846125559,-5.053465496929395,-1.2673169722649258,-3.3543049444724637,-3.6804379022696923],[-2.3580342056441834,-0.42225711543837285,5.720218163215735,1.7740563474838098,-0.6712935033720382,1.6117892548583617],[-1.41738386456563,-1.7132522968469297,5.248699033093509,-1.3668085668646388,1.4315126080063663,-1.7665644637266453],[2.986775895080872,-1.4262840268107106,3.301387625986469,-0.33972409941766923,-6.6007779569129275,1.7025002145218915],[-3.5655305420486854,-1.404688138364576,-1.7077082091885152,-0.5730189158519109,3.1922628440881624,-2.565008702381239],[-0.4762364043199235,-1.0911883186949987,-0.504871991862471,-2.0828185170577598,6.208868309162677,4.261761038531024],[1.2656574277115726,-2.9392525250898025,2.781125568784189,-2.015807699087488,-4.862359748295797,-3.9433822276968717],[0.2598874175647494,0.8639783637173816,-0.5733839455202729,2.8505998893724174,-0.2252844649382969,-3.2590050649959266],[0.259762923078081,2.7749922367884423,-4.229555410769571,-2.109726626178205,-1.6897440871481875,7.059884815318992],[1.9210956596142261,-1.7804766639784797,4.8498412768172505,-2.5215155558262827,-1.6953775462078875,-3.248827044131152],[-4.161724686450129,2.4879509828517516,-3.7475224033816743,-4.645027595669395,-4.882960510740931,-1.557471258230581]]},\"weights_ho\":{\"rows\":3,\"cols\":15,\"data\":[[0.880481767346067,2.7266267850928854,4.307201068906364,1.9924825155040953,-0.176414992177398,-1.3466195749669796,3.37583537406808,1.1028576534777512,-0.6763853776263028,0.72485269545487,-4.439470397981011,2.929319000644493,-3.392287086442666,-3.653942259645179,0.8665633017399691],[-1.4612980408546807,-2.075768832763121,1.3103502208560571,2.9799319034202814,-3.036970001202708,-1.3664658823944569,1.7324420400552718,-4.746465031661976,0.35892678480052487,4.064265906914089,-4.659265107790953,0.4316006910265588,5.119967460998209,-2.283888283195805,-1.6704162224159664],[4.095818020806549,-0.1755154853057388,0.6339599584154239,-0.5175893562374254,-0.11966964533224064,-1.1085069904689904,0.9993096189491311,2.8652353484190547,-3.8431806059335956,-6.586668598337352,2.033513405192935,-2.504664524529267,-6.10971026566882,5.265260710086138,-2.806530837575745]]},\"bias_h\":{\"rows\":15,\"cols\":1,\"data\":[[0.9549517700710063],[-3.746647600535911],[-4.951812422191008],[-1.3053273105321657],[1.855024718836487],[-2.1190613927070743],[5.218099428016399],[-0.7287730278925733],[-0.5551199204519514],[-2.5406646512543],[4.156664825672358],[0.20098798304186347],[-3.5167172899148182],[-0.40859197079010756],[4.581886493236113]]},\"bias_o\":{\"rows\":3,\"cols\":1,\"data\":[[-2.3408477538856696],[3.3981790828363416],[0.4137116241086353]]},\"learning_rate\":0.1,\"activation_function\":{}}"


"{\"input_nodes\":6,\"hidden_nodes\":10,\"output_nodes\":3,\"weights_ih\":{\"rows\":10,\"cols\":6,\"data\":[[-0.8664760322812675,0.2871443841474384,-3.6357736052285974,0.26876835457633075,0.8339394996958494,0.27287279046255086],[0.9049455380837741,-1.8034954389118245,-2.16427969879081,1.743761467345836,0.7063523160492812,-0.10737819796548159],[2.0031190381970054,-0.6330899888436436,0.4935134768544868,-2.3222689878911655,1.9887483128266892,-0.5623149445588335],[-0.7007345333129602,0.11685827620724587,0.8113088987337447,-1.1360179227177127,0.5586884977690983,0.7498897401692295],[-0.39969631321571164,0.3295556475903933,-1.307963159386859,0.6265846519058491,-0.7894181761254441,-1.1929057810794679],[-0.9747124684581882,-3.036084187385813,0.3227357368196886,0.22948498213637336,1.0608068255209335,-1.8953005611387335],[0.16716973823937953,1.4463421586532497,-1.2831243555766552,1.4433130601650332,-0.9291210013974446,0.8447048845041543],[-2.4535261871939404,-0.9860447177751748,-2.815692058812362,2.973474985378311,0.9243144385834181,-0.9947136064838641],[0.9413661072890014,-3.132540152092885,-0.8188392942925334,0.8207252035856623,2.595962687862175,-3.854050022798791],[1.509220795077071,-0.37422164249018275,-1.9960789530252725,-1.1241267920196574,-0.5219692588714404,0.4229426622018388]]},\"weights_ho\":{\"rows\":3,\"cols\":10,\"data\":[[-0.11835422413656932,-1.0324617031011005,0.5822497506525921,-1.5816918394298782,-2.7845318171759876,-1.2774035314402952,1.7774196333059908,1.3002135560996044,0.6912467214018823,-1.341892051733452],[0.3533339139914097,0.7620603114913367,0.15854787663437173,1.7200364600719436,0.051043060827902886,0.10384877424889052,0.38577302751984494,-1.1449363017702399,1.1110152212262183,0.652797786287873],[-0.2576172148491639,0.24679453283927832,-1.6770027172575563,-0.455819776121387,-0.8150000358735694,1.3366591624315767,0.18979238219794678,1.5336721162519122,-1.428817105847905,-0.6127919789563478]]},\"bias_h\":{\"rows\":10,\"cols\":1,\"data\":[[1.6274670022825992],[-2.6273368873328504],[-0.8288614977702653],[0.0667262606520447],[-0.42145364987716855],[3.3547719215809075],[-0.5562736611478835],[1.3309423967310088],[-0.4448452608295554],[1.3424542361916065]]},\"bias_o\":{\"rows\":3,\"cols\":1,\"data\":[[1.665789509232054],[0.8992977615710384],[-0.2050263421304977]]},\"learning_rate\":0.1,\"activation_function\":{}}"
*/
